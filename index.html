<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TimeMachine TV</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* small extra polish */
    body { background: linear-gradient(135deg,#0f172a 0%, #1e293b 50%, #0f172a 100%); }
    .glass { background: rgba(255,255,255,0.04); backdrop-filter: blur(6px); }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-6 text-slate-100">
  <div class="w-full max-w-5xl glass rounded-2xl p-6 shadow-2xl">
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-3xl font-extrabold">TimeMachine TV</h1>
        <p class="text-slate-300 mt-1">Powered by TimeMachine ARTIFACTS for Videos</p>
      </div>
      <div class="text-sm text-slate-300">
        <div class="mb-1">Model</div>
        <div class="flex gap-2">
          <button id="btn-plus" class="px-3 py-1 rounded-lg font-medium bg-indigo-600">TV Plus<br><span class="text-xs">DUAL VISION</span></button>
          <button id="btn-pro" class="px-3 py-1 rounded-lg font-medium bg-white/5">TV Pro<br><span class="text-xs">TM PRO (Based)</span></button>
        </div>
      </div>
    </header>

    <main class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <form id="form" class="md:col-span-1 space-y-4">
        <label class="block text-slate-200">Prompt</label>
        <textarea id="prompt" rows="6" class="w-full rounded-lg p-3 bg-white/5 text-slate-100 placeholder:text-slate-400" placeholder="Describe the scene you want the model to generate...">A cinematic short of an old city street at dusk, filmic, moody lighting</textarea>

        <div>
          <label class="text-slate-200">Key (editable)</label>
          <input id="key" class="w-full rounded-md p-2 bg-white/5" value="plln_sk_9p1ezHOVsb2XB96WV3tJSYvDvFLpho3i" />
        </div>

        <div class="flex gap-2 items-center">
          <label class="flex items-center gap-2"><input type="checkbox" id="private" checked /> <span class="text-slate-300">private</span></label>
          <label class="flex items-center gap-2"><input type="checkbox" id="enhance" /> <span class="text-slate-300">enhance</span></label>
          <label class="flex items-center gap-2"><input type="checkbox" id="nologo" checked /> <span class="text-slate-300">nologo</span></label>
        </div>

        <div class="flex gap-2 items-center">
          <label class="text-slate-300">Quality</label>
          <select id="quality" class="rounded-md bg-white/5 p-1">
            <option value="high">high</option>
            <option value="medium">medium</option>
            <option value="low">low</option>
          </select>
        </div>

        <div class="flex gap-2 mt-3">
          <button id="generate" class="flex-1 bg-gradient-to-r from-indigo-500 to-rose-500 px-4 py-2 rounded-lg font-semibold">Generate</button>
          <button id="reset" type="button" class="px-4 py-2 rounded-lg bg-white/5">Reset</button>
        </div>

        <div class="mt-3 text-xs text-slate-400">This constructs a server-side generation URL and attempts to load it into the preview. If the endpoint returns HTML or CORS blocks the browser, open the link in a new tab or proxy the request server-side.</div>

        <div class="mt-4 text-xs text-slate-300">Constructed URL (read-only)</div>
        <input id="constructed" readonly class="w-full rounded-md p-2 bg-white/5 text-xs" />

        <div id="error" class="text-sm text-rose-400"></div>
      </form>

      <section class="md:col-span-2 space-y-4">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-xl font-bold">Preview</h2>
            <p class="text-slate-400 text-sm">Video will appear here after you click Generate.</p>
          </div>

          <div class="flex gap-2 items-center">
            <button id="openlink" class="px-3 py-1 rounded-md bg-white/5">Open link</button>
            <button id="download" class="px-3 py-1 rounded-md bg-white/5" disabled>Download</button>
          </div>
        </div>

        <div id="preview" class="rounded-2xl bg-black/40 border border-white/5 p-4 min-h-[320px] flex items-center justify-center">
          <div id="placeholder" class="text-slate-400">No video yet. Enter a prompt and click Generate.</div>
        </div>

        <div class="mt-2 text-xs text-slate-400">Tip: If the preview does not load, click "Open link" to open the generated URL in a new tab or use a server-side proxy to fetch the generated file.</div>
      </section>
    </main>

    <footer class="mt-6 text-sm text-slate-400 flex justify-between">
      <div>Built with ❤️ — TimeMachine Mafia</div>
      <div>Models: TV Plus • TV Pro</div>
    </footer>
  </div>

  <script>
    (function(){
      const modelMap = { 'tv-plus': 'seedance', 'tv-pro': 'veo' };
      let flavor = 'tv-plus';

      const btnPlus = document.getElementById('btn-plus');
      const btnPro = document.getElementById('btn-pro');
      const promptEl = document.getElementById('prompt');
      const keyEl = document.getElementById('key');
      const privateEl = document.getElementById('private');
      const enhanceEl = document.getElementById('enhance');
      const nologoEl = document.getElementById('nologo');
      const qualityEl = document.getElementById('quality');
      const constructedEl = document.getElementById('constructed');
      const errorEl = document.getElementById('error');
      const previewEl = document.getElementById('preview');
      const placeholder = document.getElementById('placeholder');
      const generateBtn = document.getElementById('generate');
      const resetBtn = document.getElementById('reset');
      const openLinkBtn = document.getElementById('openlink');
      const downloadBtn = document.getElementById('download');

      function setActiveButtons(){
        if(flavor === 'tv-plus'){
          btnPlus.classList.add('bg-indigo-600'); btnPlus.classList.remove('bg-white/5');
          btnPro.classList.remove('bg-rose-600'); btnPro.classList.add('bg-white/5');
        } else {
          btnPro.classList.add('bg-rose-600'); btnPro.classList.remove('bg-white/5');
          btnPlus.classList.remove('bg-indigo-600'); btnPlus.classList.add('bg-white/5');
        }
      }

      btnPlus.addEventListener('click',()=>{ flavor='tv-plus'; setActiveButtons(); updateConstructed(); });
      btnPro.addEventListener('click',()=>{ flavor='tv-pro'; setActiveButtons(); updateConstructed(); });

      function buildPollinationsUrl(prompt){
        const model = modelMap[flavor] || 'seedance';
        const encoded = encodeURIComponent((prompt||'').trim());
        const params = [];
        params.push('enhance=' + (enhanceEl.checked ? 'true':'false'));
        params.push('private=' + (privateEl.checked ? 'true':'false'));
        params.push('nologo=' + (nologoEl.checked ? 'true':'false'));
        params.push('model=' + model);
        params.push('quality=' + encodeURIComponent(qualityEl.value));
        if(keyEl.value) params.push('key=' + encodeURIComponent(keyEl.value));
        return `https://enter.pollinations.ai/api/generate/image/${encoded}?${params.join('&')}`;
      }

      function updateConstructed(){
        constructedEl.value = buildPollinationsUrl(promptEl.value);
      }

      // wire inputs to update constructed url
      [promptEl,keyEl,privateEl,enhanceEl,nologoEl,qualityEl].forEach(el=>{
        el.addEventListener('input', updateConstructed);
        el.addEventListener('change', updateConstructed);
      });

      // generate behavior
      let currentUrl = '';
      generateBtn.addEventListener('click', function(e){
        e.preventDefault();
        errorEl.textContent = '';
        previewEl.innerHTML = '';

        if(!promptEl.value.trim()){
          errorEl.textContent = 'Please enter a prompt.'; return;
        }

        const url = buildPollinationsUrl(promptEl.value);
        currentUrl = url;
        constructedEl.value = url;

        // show loading
        const loading = document.createElement('div');
        loading.className = 'text-center';
        loading.innerHTML = '<div class="animate-spin rounded-full h-10 w-10 border-b-2 border-white/60 mx-auto"></div><div class="mt-2 text-slate-300">Loading...</div>';
        previewEl.appendChild(loading);

        // create video element and try to load url
        const video = document.createElement('video');
        video.controls = true;
        video.className = 'w-full rounded-xl max-h-[560px]';
        const src = document.createElement('source');
        src.src = url;
        video.appendChild(src);

        // handlers
        let loaded = false;
        video.addEventListener('loadeddata', ()=>{
          loaded = true;
          previewEl.innerHTML = '';
          previewEl.appendChild(video);
          downloadBtn.disabled = false;
        });
        video.addEventListener('error', ()=>{
          previewEl.innerHTML = '';
          const msg = document.createElement('div');
          msg.className = 'text-slate-300';
          msg.innerHTML = 'Video failed to load from the generated URL. This can happen due to CORS or because the generation endpoint returns HTML. <br><button id="openfail" class="mt-2 px-3 py-1 rounded bg-white/5">Open link</button>';
          previewEl.appendChild(msg);
          document.getElementById('openfail').addEventListener('click', ()=> window.open(url, '_blank'));
          downloadBtn.disabled = true;
        });

        // attempt to load by attaching and letting browser fetch
        // small timeout: if not loaded after ~6s, leave the loading state (video will call error if needed)
        setTimeout(()=>{ if(!loaded && previewEl.contains(loading)){
          // keep loading until event fires, but user can open link
          const info = document.createElement('div');
          info.className = 'text-slate-300';
          info.innerHTML = 'Still loading — if nothing appears try "Open link" or proxy the request.';
          previewEl.appendChild(info);
        } }, 6000);

        // replace loading with video element (browser will attempt to load)
        previewEl.innerHTML = '';
        previewEl.appendChild(video);

        openLinkBtn.disabled = false;
        downloadBtn.disabled = true; // enable once loaded successfully
      });

      openLinkBtn.addEventListener('click', ()=>{ if(currentUrl) window.open(currentUrl,'_blank'); });
      downloadBtn.addEventListener('click', ()=>{
        if(!currentUrl) return;
        const a = document.createElement('a');
        a.href = currentUrl;
        a.download = `timemachine-${Date.now()}.mp4`;
        a.target = '_blank';
        document.body.appendChild(a);
        a.click();
        a.remove();
      });

      resetBtn.addEventListener('click', ()=>{
        promptEl.value = '';
        keyEl.value = '';
        privateEl.checked = true;
        enhanceEl.checked = false;
        nologoEl.checked = true;
        qualityEl.value = 'high';
        constructedEl.value = '';
        previewEl.innerHTML = '<div id="placeholder" class="text-slate-400">No video yet. Enter a prompt and click Generate.</div>';
        errorEl.textContent = '';
        currentUrl = '';
        downloadBtn.disabled = true;
      });

      // initialize
      updateConstructed();
      setActiveButtons();
      openLinkBtn.disabled = true;
      downloadBtn.disabled = true;

    })();
  </script>
</body>
</html>
